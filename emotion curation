import React, { useState, useEffect, useCallback } from 'react';

// --- ì•„ì´ì½˜ (lucide-react ì‹œë®¬ë ˆì´ì…˜) ---
const Play = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>
);
const Pause = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
);
const ArrowLeft = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
);
const HomeIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
);


// --- src/data/... ---
const actionItems = [
    {id: 'breath_1', type: 'breath', durationSec: 60, title: 'í¸ì•ˆí•œ í˜¸í¡ 1ë¶„', copy: 'ìˆ¨ì„ 4ì´ˆê°„ ë“¤ì´ë§ˆì‹œê³ , 6ì´ˆê°„ ë‚´ì‰¬ë©° ëª¸ì˜ ê¸´ì¥ì„ í’€ì–´ë³´ì„¸ìš”.'},
    {id: 'self_compassion_1', type: 'journal', durationSec: 120, title: 'ìê¸°ì¹œì ˆ ìŠ¤í¬ë¦½íŠ¸ 2ë¶„', copy: 'ë”°ëœ»í•œ ì»µì„ ì¡ê³ , ì´ ìˆœê°„ì„ ê²¬ë””ëŠ” ë‚˜ë¥¼ ë”°ëœ»í•˜ê²Œ ì•ˆì•„ì£¼ì„¸ìš”.'}
];

const assessmentChapters = [
    { id: 'CH1', title: 'ê°ì • ëª…ë£Œí™”', description: 'ë‚´ ê°ì •ì„ ì–¼ë§ˆë‚˜ ì„ ëª…í•˜ê²Œ ì¸ì‹í•˜ê³  ì´ë¦„ ë¶™ì¼ ìˆ˜ ìˆë‚˜ìš”?' },
    { id: 'CH2', title: 'íŠ¸ë¦¬ê±° ì¸ì‹', description: 'ë‚´ ê°ì •ì„ ì›€ì§ì´ëŠ” ë‚´/ì™¸ë¶€ ì‹ í˜¸ë¥¼ ì–¼ë§ˆë‚˜ ì˜ ì•„ë‚˜ìš”?' },
    { id: 'CH3', title: 'ëª¸ê°ê° & ë‚´ì¥ê°ê°', description: 'ëª¸ì´ ë³´ë‚´ëŠ” ë¯¸ì„¸í•œ ì‹ í˜¸ë¥¼ ê°ì§€ì™€ ì—°ê²°í•˜ë‚˜ìš”?' },
    { id: 'CH4', title: 'ìŠ¤íŠ¸ë ˆìŠ¤ & í™œì„±ë„ ì¡°ì ˆ', description: 'ê°ì •ì˜ íŒŒë„ë¥¼ ì–¼ë§ˆë‚˜ ëŠ¥ìˆ™í•˜ê²Œ ë‹¤ë£¨ë‚˜ìš”?' },
    { id: 'CH5', title: 'ìê¸°ìë¹„ & ìê¸°ëŒ€í™”', description: 'ìŠ¤ìŠ¤ë¡œì—ê²Œ ì–¼ë§ˆë‚˜ ë”°ëœ»í•œ ì¹œêµ¬ê°€ ë˜ì–´ì£¼ë‚˜ìš”?' },
    { id: 'CH6', title: 'ê´€ê³„ & ê²½ê³„', description: 'ê±´ê°•í•œ ê´€ê³„ë¥¼ ìœ„í•œ ê°ì • ì†Œí†µ ëŠ¥ë ¥ì„ ì ê²€í•´ìš”.' },
];

const assessmentQuestions = {
    'CH1': [{ id: 'q1_1', text: 'ì§€ê¸ˆ ê°ì •ì„ í•œ ë‹¨ì–´ë¡œ ì§‘ì–´ë„£ëŠ” ê²ƒì´ ì–´ë µì§€ ì•Šë‹¤.' }, { id: 'q1_2', text: 'í•œ ìƒí™©ì—ì„œ ë³µí•© ê°ì •(ì˜ˆ: ì•ˆë„+ë¶ˆì•ˆ)ì„ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.' }, { id: 'q1_3', text: 'ê°ì •ê³¼ ìƒê°ì„ ë³„ê°œë¡œ ì¸ì‹í•œë‹¤.' }],
    'CH2': [{ id: 'q2_1', text: 'ë°˜ë³µì ìœ¼ë¡œ ë‚˜ë¥¼ í”ë“œëŠ” ì‚¬ëŒ/ìƒí™©ì„ ì•Œê³  ìˆë‹¤.' }, { id: 'q2_2', text: 'ì—…ë¬´/ì‹œê°„ì••ë°•ì´ ë‚´ ê°ì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ íŒŒì•…í•œë‹¤.' }, { id: 'q2_3', text: 'ë‚ ì”¨Â·ì†ŒìŒÂ·ì¥ì†Œ ë“± í™˜ê²½ íŠ¸ë¦¬ê±°ë¥¼ ìì£¼ ë©”ëª¨í•œë‹¤.' }],
    'CH3': [{ id: 'q3_1', text: 'ì‹¬ë°•/í˜¸í¡/ì–´ê¹¨ ê¸´ì¥ ë³€í™”ë¥¼ ì¸ì§€í•œë‹¤.' }, { id: 'q3_2', text: 'ì†ì“°ë¦¼/ì†ìš¸ë ì„/ë‘í†µ ë“± ë¯¸ì„¸ ì‹ í˜¸ë¥¼ ê°ì •ê³¼ ì—°ê²°í•œë‹¤.' }, { id: 'q3_3', text: 'ê¸´ì¥ì´ ìŒ“ì¸ ë¶€ìœ„ë¥¼ ì†ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆë‹¤.' }],
    'CH4': [{ id: 'q4_1', text: 'í¥ë¶„Â·ê¸´ì¥ ìƒíƒœì—ì„œ ìŠ¤ìŠ¤ë¡œ ì§„ì •ì‹œí‚¤ëŠ” ë²•ì„ ì•ˆë‹¤.' }, { id: 'q4_2', text: 'ì €í™œì„±(ë¬´ê¸°ë ¥)ì¼ ë•Œ ì—ë„ˆì§€ë¥¼ ê¹¨ìš°ëŠ” ë£¨í‹´ì´ ìˆë‹¤.' }, { id: 'q4_3', text: 'ì§‘ì¤‘ì´ ííŠ¸ëŸ¬ì§ˆ ë•Œ ë‹¤ìŒ í–‰ë™ 1ê°œë¥¼ ì •í•œë‹¤.' }],
    'CH5': [{ id: 'q5_1', text: 'ì‹¤ìˆ˜í–ˆì„ ë•Œ ìì‹ ì—ê²Œ ëª¨ì§„ ë§ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.' }, { id: 'q5_2', text: 'ì¹œí•œ ì¹œêµ¬ì—ê²Œ í•˜ë“¯ ë‚˜ì—ê²Œ ë§í•œë‹¤.' }, { id: 'q5_3', text: 'ê°ì •ì„ ëŠë¼ëŠ” ë‚˜ë¥¼ ë¹„ë‚œí•˜ì§€ ì•ŠëŠ”ë‹¤.' }],
    'CH6': [{ id: 'q6_1', text: 'ë¶ˆí¸í•œ ëŒ€í™”ì—ì„œ ì‚¬ì‹¤/ëŠë‚Œ/ìš•êµ¬/ìš”ì²­ì„ êµ¬ë¶„í•œë‹¤.' }, { id: 'q6_2', text: 'ê±°ì ˆì„ ë¯¸ë£¨ì§€ ì•Šê³  ëŒ€ì•ˆì„ ì œì‹œí•œë‹¤.' }, { id: 'q6_3', text: 'ë‚˜ì˜ í•œê³„/ì—ë„ˆì§€ ìƒíƒœë¥¼ ê³µìœ í•œë‹¤.' }],
};


// --- src/lib/db.ts (localStorage ì‹œë®¬ë ˆì´ì…˜) ---
const db = {
  get: async (key) => { try { const i = window.localStorage.getItem(key); return i ? JSON.parse(i) : undefined; } catch (e) { console.error(e); return undefined; } },
  set: async (key, value) => { try { window.localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); } },
};

const saveAssessmentResult = (result) => db.set(`assessment_result-${result.chapterId}`, result);
const getAllAssessmentResults = async () => {
    const results = {};
    for (const chapter of assessmentChapters) {
        const result = await db.get(`assessment_result-${chapter.id}`);
        if (result) results[chapter.id] = result;
    }
    return results;
}
const saveEntry = (entry) => {
    db.set(`entry-${entry.id}`, entry);
    db.set('latest_entry_id', entry.id);
};

// --- ëª©ì—… ë°ì´í„° ì„¤ì • í•¨ìˆ˜ ---
const setupMockData = async () => {
    const isMockDataSetup = await db.get('mock_data_setup_complete');
    if (isMockDataSetup) return;
    const mockEntry = { id: 'entry-mock-1', userId: 'user-mira', ts: new Date().toISOString(), primaryEmotion: 'í¸ì•ˆí•¨', emotionDetail: 'ë§Œì¡±', intensity: 4, triggers: ['ì¢‹ì€ ë‚ ì”¨'], body: ['ëª¸ì´ ê°€ë²¼ì›€'] };
    await saveEntry(mockEntry);
    await saveAssessmentResult({ chapterId: 'CH1', totalScore: 32, level: 'Clear' });
    await saveAssessmentResult({ chapterId: 'CH2', totalScore: 25, level: 'Growing' });
    await db.set('mock_data_setup_complete', true);
};

// --- ê³µìš© UI ì»´í¬ë„ŒíŠ¸ ---
const Card = ({ children, className = '' }) => (<div className={`bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 sm:p-8 ${className}`}>{children}</div>);
const Button = ({ children, onClick, className = '', variant = 'default' }) => {
    const variants = {
        default: 'bg-indigo-600 text-white hover:bg-indigo-700',
        secondary: 'bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-50 hover:bg-slate-200 dark:hover:bg-slate-600',
        ghost: 'hover:bg-slate-100 dark:hover:bg-slate-700',
    };
    return (<button onClick={onClick} className={`px-4 py-2 rounded-lg font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900 ${variants[variant]} ${className}`}>{children}</button>);
};

// --- í˜ì´ì§€ë³„ ì»´í¬ë„ŒíŠ¸ ---

// 1. í™ˆ í˜ì´ì§€
const HomePage = ({ setCurrentPage }) => (
    <div className="text-center max-w-md mx-auto">
        <h1 className="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-2">ë§ˆìŒíŒ”ë ˆíŠ¸ ğŸ¨</h1>
        <p className="text-slate-600 dark:text-slate-400 mb-12">ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ë‚˜ìš”? ë‹¹ì‹ ì˜ ë§ˆìŒì„ ê¸°ë¡í•˜ê³  ëŒë´ì£¼ì„¸ìš”.</p>
        <div className="space-y-4">
            <Button onClick={() => setCurrentPage('check-in')} className="w-full !py-3 !text-lg">
                ì˜¤ëŠ˜ì˜ ë§ˆìŒ ì²´í¬ì¸í•˜ê¸°
            </Button>
            <Button onClick={() => setCurrentPage('assessment')} className="w-full !py-3 !text-lg" variant="secondary">
                ë§ˆìŒ ê·¼ë ¥ ì§„ë‹¨í•˜ê¸°
            </Button>
             <Button onClick={() => setCurrentPage('report')} className="w-full mt-8" variant="ghost">
                ìµœê·¼ ë¦¬í¬íŠ¸ ë³´ê¸°
            </Button>
        </div>
    </div>
);

// 2. ì²´í¬ì¸ í˜ì´ì§€
const CheckInPage = ({ onComplete }) => {
    const [step, setStep] = useState(1);
    const [entry, setEntry] = useState({ primaryEmotion: '', intensity: 5, triggers: [], body: [], emotionDetail: '' });

    const EmotionPaletteWheel = ({ onSelectEmotion }) => {
        const emotions = [ { name: 'ê¸°ì¨', color: '#FFD700' }, { name: 'ì„¤ë ˜', color: '#FFA500' }, { name: 'ë¶„ë…¸', color: '#DC143C' }, { name: 'ìŠ¬í””', color: '#6495ED' }, { name: 'ë¶ˆì•ˆ', color: '#9370DB' }, { name: 'í¸ì•ˆ', color: '#3CB371' }];
        return (
            <div className="flex justify-center items-center my-8">
                <svg width="300" height="300" viewBox="0 0 300 300">{emotions.map((emotion, i) => {
                    const angle = (i / emotions.length) * 2 * Math.PI - Math.PI / 2;
                    const x = 150 + 120 * Math.cos(angle); const y = 150 + 120 * Math.sin(angle);
                    return (<g key={emotion.name} onClick={() => onSelectEmotion(emotion.name)} className="cursor-pointer group"><circle cx={x} cy={y} r="40" fill={emotion.color} className="transition-transform duration-200 group-hover:scale-110"/>
                    <text x={x} y={y} textAnchor="middle" dy="0.3em" className="text-sm font-bold pointer-events-none select-none" fill="#fff">{emotion.name}</text></g>);})}
                </svg>
            </div>
        );
    };
    const IntensitySlider = ({ value, onChange }) => (<div className="w-full my-6"><label htmlFor="intensity" className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ê°ì • ê°•ë„: {value} / 10</label><input id="intensity" type="range" min="0" max="10" step="1" value={value} onChange={(e) => onChange(parseInt(e.target.value, 10))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"/></div>);
    const TagChips = ({ title, tags, selectedTags, onToggleTag }) => (<div className="my-6"><h3 className="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3">{title}</h3><div className="flex flex-wrap gap-2">{tags.map(tag => (<button key={tag} onClick={() => onToggleTag(tag)} className={`px-3 py-1.5 text-sm rounded-full transition-colors ${selectedTags.includes(tag) ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 hover:bg-slate-200'}`}>{tag}</button>))}</div></div>);

    const handleSelectEmotion = (emotion) => { setEntry(prev => ({ ...prev, primaryEmotion: emotion })); setStep(2); };
    const handleIntensityChange = (value) => setEntry(prev => ({ ...prev, intensity: value }));
    const handleToggleTag = (tag, type) => setEntry(prev => ({ ...prev, [type]: prev[type].includes(tag) ? prev[type].filter(t => t !== tag) : [...prev[type], tag] }));
    const submitCheckIn = () => {
        const fullEntry = { ...entry, id: `entry-${Date.now()}`, userId: 'user-mira', ts: new Date().toISOString() };
        saveEntry(fullEntry);
        onComplete();
    };

    return (
        <Card className="max-w-xl mx-auto">
            {step === 1 && (<div><h2 className="text-2xl font-bold text-center mb-4">ì§€ê¸ˆ ì–´ë–¤ ê°ì •ì„ ëŠë¼ì‹œë‚˜ìš”?</h2><EmotionPaletteWheel onSelectEmotion={handleSelectEmotion} /></div>)}
            {step === 2 && (<div><h2 className="text-2xl font-bold text-center mb-6">ì„ íƒí•œ ê°ì •: <span className="text-indigo-600">{entry.primaryEmotion}</span></h2><IntensitySlider value={entry.intensity} onChange={handleIntensityChange} /><Button onClick={() => setStep(3)} className="mt-8 w-full">ë‹¤ìŒ</Button></div>)}
            {step === 3 && (<div className="space-y-6"><h2 className="text-2xl font-bold text-center mb-4">ê°ì •ì— ì˜í–¥ì„ ì¤€ ê²ƒì´ ìˆë‚˜ìš”?</h2><TagChips title="ìƒí™©ì´ë‚˜ ì‚¬ê±´ (íŠ¸ë¦¬ê±°)" tags={['ì¼/ê³µë¶€', 'ì‚¬ëŒ ê´€ê³„', 'ê±´ê°•', 'ë¯¸ë˜', 'ì¢‹ì€ ë‚ ì”¨']} selectedTags={entry.triggers} onToggleTag={(tag) => handleToggleTag(tag, 'triggers')}/><TagChips title="ëª¸ì˜ ì‹ í˜¸" tags={['í”¼ê³¤í•¨', 'ê°€ìŠ´ ë‹µë‹µ', 'ëª¸ì´ ê°€ë²¼ì›€', 'ë‘í†µ']} selectedTags={entry.body} onToggleTag={(tag) => handleToggleTag(tag, 'body')}/><Button onClick={submitCheckIn} className="mt-8 w-full">ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°</Button></div>)}
        </Card>
    );
};


// 3. ì§„ë‹¨ í˜ì´ì§€
const AssessmentPage = ({ onComplete }) => {
    const [chapterId, setChapterId] = useState(null);
    const [answers, setAnswers] = useState({});
    const [result, setResult] = useState(null);

    if (result) {
        return (<Card className="text-center"><h2 className="text-2xl font-bold mb-4">{result.chapterTitle} ì§„ë‹¨ ì™„ë£Œ!</h2><p className="text-4xl font-bold my-6">{result.totalScore} / {assessmentQuestions[chapterId].length * 4}</p><p className="text-slate-600">{result.level}</p><Button onClick={() => onComplete()} className="w-full mt-6">ì „ì²´ ë¦¬í¬íŠ¸ ë³´ê¸°</Button><Button onClick={() => {setResult(null); setChapterId(null);}} className="w-full mt-2" variant="secondary">ë‹¤ë¥¸ ì±•í„° ì§„ë‹¨í•˜ê¸°</Button></Card>);
    }

    if (chapterId) {
        const questions = assessmentQuestions[chapterId] || [];
        const handleAnswer = (qId, score) => setAnswers(prev => ({...prev, [qId]: score}));
        const handleSubmit = () => {
            const totalScore = Object.values(answers).reduce((sum, val) => sum + val, 0);
            const level = totalScore > questions.length * 3 ? 'Clear' : totalScore > questions.length * 2 ? 'Growing' : totalScore > questions.length * 1 ? 'Emerging' : 'Seed';
            const newResult = { chapterId, chapterTitle: assessmentChapters.find(c=>c.id===chapterId).title, answers, totalScore, level, ts: new Date().toISOString() };
            saveAssessmentResult(newResult);
            setResult(newResult);
        }
        return (<Card><Button onClick={() => setChapterId(null)} variant="ghost" className="mb-4"><ArrowLeft className="inline-block mr-2"/>ì±•í„° ì„ íƒìœ¼ë¡œ</Button><h2 className="text-2xl font-bold text-center mb-6">{assessmentChapters.find(c=>c.id===chapterId).title}</h2><div className="space-y-6">{questions.map(q => (<div key={q.id}><p>{q.text}</p><div className="flex justify-between mt-2">{[0,1,2,3,4].map(score => <button key={score} onClick={() => handleAnswer(q.id, score)} className={`w-10 h-10 rounded-full transition-colors ${answers[q.id] === score ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200'}`}>{score}</button>)}</div></div>))}</div><Button onClick={handleSubmit} disabled={Object.keys(answers).length < questions.length} className="w-full mt-8">ê²°ê³¼ ë³´ê¸°</Button></Card>);
    }

    return (<Card><h2 className="text-2xl font-bold text-center mb-6">ë§ˆìŒ ê·¼ë ¥ ì§„ë‹¨</h2><p className="text-center text-slate-600 mb-8">ë‚˜ì˜ ë§ˆìŒì— ëŒ€í•´ ë” ê¹Šì´ ì´í•´í•˜ê¸° ìœ„í•œ 6ê°€ì§€ ì±•í„°ë¥¼ íƒìƒ‰í•´ë³´ì„¸ìš”.</p><div className="space-y-3">{assessmentChapters.map(c => <button key={c.id} onClick={()=>setChapterId(c.id)} className="w-full text-left p-4 bg-slate-50 dark:bg-slate-700 rounded-lg hover:bg-slate-100"><p className="font-semibold">{c.title}</p><p className="text-sm text-slate-500">{c.description}</p></button>)}</div></Card>);
}


// 4. ì›í˜ì´ì§€ ë¦¬í¬íŠ¸ (ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ì™€ ë™ì¼, onGoHome í”„ë¡­ ì¶”ê°€)
const OnePageReport = ({ latestEntry, assessmentResults, userName, onGoHome }) => {
    const RadarChart = ({ data }) => {
        const size = 280; const center = size / 2; const total = Object.keys(data).length; if(total === 0) return <div className="w-full h-72 bg-slate-100 rounded-lg flex items-center justify-center"><p>ì§„ë‹¨ ë°ì´í„°ê°€ ì—†ì–´ìš”.</p></div>;
        const points = Object.values(data).map((value, i) => { const angle = (i / total) * 2 * Math.PI - Math.PI / 2; const score = value.totalScore || 0; const x = center + (score / (assessmentQuestions[value.chapterId].length*4) * (center - 20)) * Math.cos(angle); const y = center + (score / (assessmentQuestions[value.chapterId].length*4) * (center - 20)) * Math.sin(angle); return `${x},${y}`; }).join(' ');
        const labels = Object.keys(data).map((key, i) => { const angle = (i / total) * 2 * Math.PI - Math.PI / 2; const x = center + (center - 5) * Math.cos(angle); const y = center + (center - 5) * Math.sin(angle); return <text key={key} x={x} y={y} fontSize="12" textAnchor="middle" dy="0.3em" className="fill-slate-600 dark:fill-slate-400 font-semibold">{assessmentChapters.find(c=>c.id===key).title}</text>; });
        return (<div className="flex justify-center items-center"><svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>{ [...Array(4)].map((_, i) => (<circle key={i} cx={center} cy={center} r={(i + 1) * (center-20)/4} fill="none" className="stroke-slate-200 dark:stroke-slate-700" strokeWidth="1"/>))}{labels}<polygon points={points} className="fill-indigo-500/30 stroke-indigo-600" strokeWidth="2" /></svg></div>);
    };
    const MicroActionTimer = ({ action, onComplete }) => {
        const { durationSec, title, copy } = action; const [timeLeft, setTimeLeft] = useState(durationSec); const [isActive, setIsActive] = useState(false);
        useEffect(() => { let interval = null; if (isActive && timeLeft > 0) { interval = setInterval(() => setTimeLeft(t => t - 1), 1000); } else if (timeLeft === 0 && isActive) { setIsActive(false); onComplete(); } return () => clearInterval(interval); }, [isActive, timeLeft, onComplete]);
        return (<Card className="text-center bg-indigo-50 dark:bg-slate-700 border border-indigo-200 dark:border-slate-600"><h3 className="text-lg font-bold text-indigo-800 dark:text-indigo-200">{title}</h3><p className="text-slate-600 dark:text-slate-400 mt-2 mb-6">{copy}</p><div className="text-6xl font-mono font-bold text-indigo-600 dark:text-indigo-400 my-4">{String(Math.floor(timeLeft / 60)).padStart(2, '0')}:{String(timeLeft % 60).padStart(2, '0')}</div><Button onClick={() => setIsActive(!isActive)} className="w-24">{isActive ? <Pause className="inline-block"/> : <Play className="inline-block"/>}{isActive ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}</Button></Card>);
    };
    const recommendedAction = latestEntry?.intensity >= 7 ? actionItems[1] : actionItems[0];
    return (<div className="max-w-2xl mx-auto space-y-8"><header className="text-center pt-8"><h1 className="text-4xl font-bold text-slate-800 dark:text-slate-100">ì˜¤ëŠ˜ì˜ ë§ˆìŒ ë¦¬í¬íŠ¸ ğŸ“</h1><p className="mt-2 text-slate-600 dark:text-slate-400">{userName}ë‹˜, ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³  ë§ìœ¼ì…¨ì–´ìš”.</p></header><Card><h2 className="text-2xl font-bold mb-4 flex items-center">ì˜¤ëŠ˜ì˜ ë§ˆìŒ ìš”ì•½ {latestEntry?.intensity >= 7 ? 'ğŸ˜”' : 'ğŸ˜Š'}</h2><div className="bg-slate-50 dark:bg-slate-700/50 p-6 rounded-xl space-y-4"><div className="flex justify-between items-baseline"><span className="text-slate-500">ì£¼ìš” ê°ì •</span><span className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{latestEntry?.primaryEmotion}</span></div><div className="flex justify-between items-baseline"><span className="text-slate-500">ê°ì • ê°•ë„</span><div className="flex items-center gap-2"><div className="w-32 h-2.5 bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden"><div className="h-full bg-red-400" style={{width: `${(latestEntry?.intensity || 0) * 10}%`}}></div></div><span className="font-bold w-6 text-right">{latestEntry?.intensity}/10</span></div></div><div className="flex justify-between items-baseline"><span className="text-slate-500">ì˜í–¥ì„ ì¤€ ê²ƒ</span><span className="font-semibold text-slate-700 dark:text-slate-300">{latestEntry?.triggers?.join(', ')}</span></div><div className="flex justify-between items-baseline"><span className="text-slate-500">ëª¸ì˜ ì‹ í˜¸</span><span className="font-semibold text-slate-700 dark:text-slate-300">{latestEntry?.body?.join(', ')}</span></div></div></Card><Card><h2 className="text-2xl font-bold mb-4 flex items-center">ì ì‹œ ì‰¬ì–´ê°€ìš” ğŸ§˜â€â™€ï¸</h2><p className="text-slate-600 dark:text-slate-400 mb-6">ì§€ê¸ˆì˜ ê°ì •ì„ ëŒë³´ê¸° ìœ„í•´ ì ì‹œ ì‹œê°„ì„ ê°€ì ¸ë³´ëŠ” ê±´ ì–´ë•Œìš”? ì‘ì€ í–‰ë™ í•˜ë‚˜ê°€ í° ë³€í™”ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</p><MicroActionTimer action={recommendedAction} onComplete={() => alert("ì˜ í•˜ì…¨ì–´ìš”! ë§ˆìŒì´ í•œê²° í¸ì•ˆí•´ì¡Œì„ ê±°ì˜ˆìš”.")} /></Card><Card><h2 className="text-2xl font-bold mb-2 flex items-center">ë‚˜ì˜ ì„±ì¥ ê¸°ë¡ ğŸŒ±</h2><p className="text-slate-600 dark:text-slate-400 mb-6">ì§„ë‹¨ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì•Œì•„ë³¸ {userName}ë‹˜ì˜ ë§ˆìŒ ê·¼ë ¥ì´ì—ìš”. ê³¨ê³ ë£¨ ì„±ì¥í•˜ê³  ìˆëŠ”ì§€ ì‚´í´ë³´ì„¸ìš”.</p><RadarChart data={assessmentResults} /><div className="mt-6 space-y-3">{Object.entries(assessmentResults).map(([key, value]) => (<div key={key} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"><span className="font-semibold text-slate-700 dark:text-slate-300">{assessmentChapters.find(c=>c.id===key).title}</span><div className="flex items-center gap-3"><span className="text-xs font-bold text-indigo-500">{value.level}</span><span className="font-bold text-slate-800 dark:text-slate-100 w-12 text-right">{value.totalScore}/{assessmentQuestions[key].length * 4}</span></div></div>))}</div></Card>
        <div className="text-center py-4"><Button onClick={onGoHome} variant="secondary"><HomeIcon className="inline-block mr-2"/>ì²˜ìŒìœ¼ë¡œ</Button></div>
    </div>);
};


// --- ë©”ì¸ App ì»´í¬ë„ŒíŠ¸ ---
export default function App() {
    const [currentPage, setCurrentPage] = useState('home'); // home, check-in, assessment, report
    const [isLoading, setIsLoading] = useState(true);
    const [reportData, setReportData] = useState({ latestEntry: null, assessmentResults: {}, userName: "ë¯¸ë¼" });

    const refreshReportData = useCallback(async () => {
        setIsLoading(true);
        const latestEntryId = await db.get('latest_entry_id');
        const entry = latestEntryId ? await db.get(`entry-${latestEntryId}`) : null;
        const assessments = await getAllAssessmentResults();
        setReportData(prev => ({ ...prev, latestEntry: entry, assessmentResults: assessments }));
        setIsLoading(false);
    }, []);

    useEffect(() => {
        const initialize = async () => {
            await setupMockData();
            refreshReportData();
        };
        initialize();
    }, [refreshReportData]);
    
    const handleFlowComplete = () => {
        refreshReportData();
        setCurrentPage('report');
    };

    const renderPage = () => {
        if (isLoading) {
            return <div className="flex items-center justify-center h-full text-slate-500">ë§ˆìŒ ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
        }
        
        switch (currentPage) {
            case 'check-in': return <CheckInPage onComplete={handleFlowComplete} />;
            case 'assessment': return <AssessmentPage onComplete={handleFlowComplete} />;
            case 'report': return <OnePageReport {...reportData} onGoHome={() => setCurrentPage('home')} />;
            case 'home':
            default: return <HomePage setCurrentPage={setCurrentPage} />;
        }
    };

    return (
        <div className="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-50 min-h-screen font-sans">
            <main className="container mx-auto px-4 py-8 md:py-12 flex-grow flex flex-col justify-center">
                {renderPage()}
            </main>
            <footer className="text-xs text-center text-slate-400 dark:text-slate-500 p-8">
                <p>ì´ ì•±ì€ ì˜ë£Œì  ì¡°ì–¸ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì˜ ë„ì›€ì´ í•„ìš”í•˜ë©´ ê´€ë ¨ ê¸°ê´€ì— ë¬¸ì˜í•˜ì„¸ìš”.</p>
                <p className="mt-2">Â© 2025 ë§ˆìŒíŒ”ë ˆíŠ¸</p>
            </footer>
        </div>
    );
}


